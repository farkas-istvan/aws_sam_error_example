/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    // Apply the common convention plugin for shared build configuration between library and application projects.
    id 'org.example.java-common-conventions'

    // Apply the application plugin to add support for building a CLI application in Java.
    id 'application'
}

import org.gradle.internal.os.OperatingSystem;

distZip {
    eachFile { file ->
        String path = file.relativePath
        file.setPath(path.substring(path.indexOf("\\") + 1, path.length()))
    }
}

task buildZip(type: Zip) {
    from compileJava
    from processResources
    into('lib') {
        from configurations.runtimeClasspath
    }
}

task copyNativeDeps(type: Copy) {
    from(configurations.testCompileClasspath) {
        include "*.dylib", "*.so", "*.dll", "*.dylib"
    }
    into 'build/native-libs'
}

test {
    dependsOn copyNativeDeps
    systemProperty "java.library.path", 'build/libs'
}

repositories {
    mavenCentral()
    maven {
        url "https://s3.eu-central-1.amazonaws.com/dynamodb-local-frankfurt/release"
    }
}

ext {
    sqlite4javaVersion = '1.0.392';
}

dependencies {
    // https://mvnrepository.com/artifact/com.amazonaws/DynamoDBLocal
    testImplementation group: 'com.amazonaws', name: 'DynamoDBLocal', version: '1.15.0'

    // https://mvnrepository.com/artifact/com.almworks.sqlite4java/sqlite4java
    testImplementation group: 'com.almworks.sqlite4java', name: 'sqlite4java', version: sqlite4javaVersion
    if (OperatingSystem.current().isWindows()) {
        // https://mvnrepository.com/artifact/com.almworks.sqlite4java/sqlite4java-win32-x64
        testImplementation group: 'com.almworks.sqlite4java', name: 'sqlite4java-win32-x64', version: sqlite4javaVersion
    } else if (OperatingSystem.current().isMacOsX()) {
        if (System.getProperty("os.arch") == "aarch64") {
            // https://mvnrepository.com/artifact/io.github.ganadist.sqlite4java/libsqlite4java-osx-aarch64
            testImplementation group: 'io.github.ganadist.sqlite4java', name: 'libsqlite4java-osx-aarch64', version: sqlite4javaVersion
        } else {
            // https://mvnrepository.com/artifact/com.almworks.sqlite4java/libsqlite4java-osx
            testImplementation group: 'com.almworks.sqlite4java', name: 'libsqlite4java-osx', version: sqlite4javaVersion
        }
    } else if (OperatingSystem.current().isLinux()) {
        // https://mvnrepository.com/artifact/com.almworks.sqlite4java/libsqlite4java-linux-amd64
        testImplementation group: 'com.almworks.sqlite4java', name: 'libsqlite4java-linux-amd64', version: sqlite4javaVersion
    }
}
